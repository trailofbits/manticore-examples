import sys
from manticore import Manticore

prog = sys.argv[1]
params = sys.argv[2:]

m = Manticore(prog, params)
# 'trace' will contain the executed instructions
m.context['trace'] = []

# None: The hook will be applied to all the instructions
@m.hook(None)
def record_trace(state):
    pc = state.cpu.PC
    ins = state.cpu.instruction
    # Store the instruction
    m.context['trace'] += [pc]

    # We manipulate directly capstone instruction
    m.context['last_ins'] = "%s %s" % (ins.mnemonic, ins.op_str)
m.run()

# Print number of instructions recorded and the last executed
print "%d instructions are recorded" % len(m.context['trace'])
print "Last instruction executed:" 
print "0x%x: %s" % (m.context['trace'][-1], m.context['last_ins'])
